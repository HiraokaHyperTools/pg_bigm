# pg_bigm

[pgbigm/pg_bigm: The pg_bigm module provides full text search capability in PostgreSQL. This module allows a user to create 2-gram (bigram) index for faster full text search.](https://github.com/pgbigm/pg_bigm) „Çí„ÄÅPostgreSQL 9.6 - 17.0 Windows Áâà„ÅßÊ•Ω„Åó„ÇÅ„Çã„Çà„ÅÜ„Å´Âä©Âäõ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ Ëá™ÁÇäÊñπÊ≥ï„Å´„Å§„ÅÑ„Å¶„ÅØ build.md „ÇíÂèÇÁÖß„ÄÇ

## „Ç§„É≥„Çπ„Éà„Éº„É´ÊñπÊ≥ï

[Releases](https://github.com/HiraokaHyperTools/pg_bigm/releases/) „Åã„Çâ `20250925.7z` „Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶Â±ïÈñã„Åó„Åæ„Åô„ÄÇ

PostgreSQL 17.x Windows x86-64 „ÅÆÂ†¥Âêà:

`pg_bigm-postgresql-17.0-x64` „Éï„Ç©„É´„ÉÄ„Éº„ÅÆ‰∏≠Ë∫´„Çí `C:\Program Files\PostgreSQL\17` „Å∏„Ç≥„Éî„Éº

pg_bigm „ÅØ„ÄÅ„Éá„Éº„Çø„Éô„Éº„Çπ„Åî„Å®„Å´„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÂØæË±°„ÅÆ„Éá„Éº„Çø„Éô„Éº„Çπ„Åß SQL Êñá„ÇíÂÆüË°å:

```sql
CREATE EXTENSION pg_bigm;
```

„ÅÑ„Åæ„Åè„ÅÑ„Åë„Å∞„ÄÅ„Åì„Çå„ÅßÂÆå‰∫Ü„Åß„Åô„ÄÇ

## ‰ΩøÁî®‰æã

[sql/pg_bigm_ja.sql](sql/pg_bigm_ja.sql) „ÇíÂèÇÁÖß„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ ÂÆü‰æã„ÅåË®òËºâ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

## „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàêÊñπÊ≥ï

```sql
-- tests for creation of full-text search index
CREATE TABLE test_bigm (col1 text, col2 text);
CREATE INDEX test_bigm_idx ON test_bigm USING gin (col1 gin_bigm_ops);
```

## Ê§úÁ¥¢ÊñπÊ≥ï (ÈÉ®ÂàÜ‰∏ÄËá¥)

```sql
SELECT col1 FROM test_bigm WHERE col1 LIKE likequery('Êù±‰∫¨ÈÉΩ');
```

## È´òÈÄüÂåñ„ÅÆÂéüÁêÜ

`pg_bigm` „ÅØ [64.4. GIN„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ](https://www.postgresql.jp/document/17/html/gin.html) „ÇíÂÆüË£Ö„Åó„Åæ„Åô„ÄÇ (ÈÄÜ„Å´„ÅÑ„ÅÜ„Å® GIN ‰ª•Â§ñ„ÅÆ B-Tree, GiST, BRIN, „Éè„ÉÉ„Ç∑„É•„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÁ≠â„ÅØÂÆüË£Ö„Åó„Åæ„Åõ„Çì)

„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅÆÂØæË±°Áâ©„ÅØ„ÄÅ„Éê„Ç§„Ç∞„É©„É†„Åß„Åô„ÄÇ

„Éê„Ç§„Ç∞„É©„É†„Å®„ÅØ„ÄÅ 2 ÊñáÂ≠ó„Åã„Çâ„Å™„ÇãÊñáÂ≠óÂàó„ÅÆ‰∫ã„Åß„Åô„ÄÇ‰æã: `ai`, `ÊñáÂ≠ó`, `üëãüòÄ`

UTF-8 „Ç®„É≥„Ç≥„Éº„Éâ‰ΩøÁî®ÊôÇ„ÅØ„ÄÅ UTF-32 „ÅÆÊñáÂ≠óÊï∞„Å®Âêå„Åò„Åß„Åô„ÄÇ

ÂèÇËÄÉ:

| ÊñáÂ≠ó | UTF-16 | UTF-32 |
|---|---|---|
| `ai` | `U+0061` `U+0069` | `U+00061` `U+00069` |
| `ÊñáÂ≠ó` | `U+6587` `U+5B57` | `U+06587` `U+05B57` |
| `üëãüòÄ` | `U+D83D` `U+DC4B` `U+D83D` `U+DE00` | `U+1F44B` `U+1F600` |

„Åì„Çå„Çâ„ÅÆ„Éê„Ç§„Ç∞„É©„É†Áæ§„Çí„ÄÅÊ±éÁî®Ëª¢ÁΩÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ (Generalized Inverted Index) „Å∏‰øùÂ≠ò„Åô„Çã‰∫ã„Åß„ÄÅÈ´òÈÄü„Å´Ê§úÁ¥¢„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã„ÅÆ„Åå pg_bigm „Åß„Åô„ÄÇ

„Çè„Åã„Çä„Å´„Åè„ÅÑ„Åß„Åô„Åã„ÄÇ Êú¨„ÅÆÂ∑ªÊú´Á¥¢Âºï„ÇíÊÄù„ÅÑÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ ËæûÊõ∏È†Ü („ÅÇ ÔΩû „Çì) „Å´‰∏¶„Åπ„ÅüÂçòË™û„Å®„ÄÅ„Éö„Éº„Ç∏Áï™Âè∑‰∏ÄË¶ß„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„Åå‰ªòÈå≤„Åï„Çå„Å¶„ÅÑ„Çã„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ „Åì„Çå„Åå GIN (Ê±éÁî®Ëª¢ÁΩÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ) „ÅÆ‰∏Ä‰æã„Åß„Åô„ÄÇ

‰ΩÜ„Åó„ÄÅ PostgreSQL „ÅÆ GIN „ÅÆÂ†¥Âêà„ÅØ„ÇÇ„ÅÜÂ∞ë„ÅóË§áÈõë„Åß„Åô„ÄÇ `„Çä„Çì„Åî` „ÅßÊ§úÁ¥¢„Åô„ÇãÂ†¥Âêà„ÅØ [`„Çä„Çì`, `„Çì„Åî`] „ÅÆ‰∏°Êñπ„ÅÆ„Éê„Ç§„Ç∞„É©„É†„ÅåÂê´„Åæ„Çå„Çã„É¨„Ç≥„Éº„Éâ„ÅÆ‰∏ÄË¶ß„ÇíÂèñÂæó„Åó„Å™„Åè„Å¶„ÅØ„Å™„Çä„Åæ„Åõ„Çì„ÄÇ

[`„Çä„Çì`, `„Çì„Åî`] „ÅÆ‰∏°„Éê„Ç§„Ç∞„É©„É†„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„Çâ„Å®„ÅÑ„Å£„Å¶ `„Çä„Çì„Åî` „Å®„ÅÑ„ÅÜÂçòË™û„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„ÅØ 100% „Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ [`„Çä„Çì„Åã„ÅÑ`, `„Åü„Çì„Åî`] „ÅÆ„Éê„Ç§„Ç∞„É©„É†„Å´„Éí„ÉÉ„Éà„Åó„ÅüÂèØËÉΩÊÄß„ÇÇ„ÅÇ„Çä„Åæ„Åô„ÄÇ „Åù„ÅÜ„ÅÑ„ÅÜÂ†¥Âêà„ÅØÂÆüÈöõ„Å´„Éá„Éº„Çø„ÇíÊ§úÊüª„Åó„Å¶„ÄÅÁúüÂÅΩÁ¢∫Ë™ç„Çí„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ „Å§„Åæ„Çä„ÄÅ„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„É¨„Ç≥„Éº„Éâ„ÇíË™≠„ÅøÂèñ„Å£„Åü„ÅÜ„Åà„Åß `„Çä„Çì„Åî` „Å®„ÅÑ„ÅÜÂçòË™û„ÅåÊú¨ÂΩì„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„Å©„ÅÜ„Åã„ÅÆÊúÄÁµÇÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Å´„Å™„Çä„Åæ„Åô„ÄÇ „Åì„ÅÆÂá¶ÁêÜ„ÅÆ„Åì„Å®„Çí recheck Âá¶ÁêÜ„Å®„ÅÑ„ÅÑ„Åæ„Åô„ÄÇ

„Åì„ÅÆ recheck „ÅÆÊúâÁÑ°„ÅØ„ÄÅ„Ç¢„ÇØ„Çª„Çπ„É°„ÇΩ„ÉÉ„ÉâÂÆüË£Ö (pg_bigm „Å™„Å©) „Åå GIN „Å´ÂØæ„Åó„Å¶ÈÉΩÂ∫¶ÊåáÁ§∫„Åå„Åß„Åç„Åæ„Åô„ÄÇ pg_bigm „Åß„ÅØ„ÄÅÊ§úÁ¥¢„Åó„Åü„ÅÑ„É¶„Éã„Éº„ÇØ„Å™„Éê„Ç§„Ç∞„É©„É†Êï∞„Åå 2 ‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÅØ true „Å´„Å™„Çä„ÄÅ1 „ÅÆÂ†¥Âêà„ÅØ false „Å´„Å™„Çä„Åæ„Åô„ÄÇ ([bigm_gin.c](bigm_gin.c) „ÅÆ `gin_extract_query_bigm` „ÇíÂèÇÁÖß)

„Åì„ÅÆ recheck Âãï‰Ωú„ÇíÂº∑Âà∂ÁöÑ„Å´ Off „Å´„Åß„Åç„Çã `pg_bigm.enable_recheck` „Éë„É©„É°„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åô„Åå„ÄÅÊ§úÁ¥¢ÁµêÊûú„Åå‰∏çÊ≠£Á¢∫„Å´„Å™„Çä„Åæ„Åô„ÄÇ Êìç‰Ωú„Åó„Å™„ÅÑÊñπ„ÅåËâØ„ÅÑ„Åß„Åó„Çá„ÅÜ„ÄÇ

Âõ≥Ëß£„Åô„Çã„Å®„ÄÅ„Åì„ÅÆ„Çà„ÅÜ„Åß„Åô:

![](images/DuHJoW9WkAAps2b.jpg)

„Åì„ÅÜ„ÅÑ„Å£„ÅüÈáç„Åù„ÅÜ„Å™„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊ©üËÉΩ„Çí‰ΩøÁî®„Åó„Åü„Å®„Åó„Å¶„ÇÇ„ÄÅ„ÉÜ„Éº„Éñ„É´ÂÖ®‰Ωì„ÅÆ„Ç∑„Éº„Ç±„É≥„Ç∑„É£„É´„Çπ„Ç≠„É£„É≥„Å®ÊØîËºÉ„Åó„Å¶„ÄÅÈ´òÈÄü (Ê§úÁ¥¢ÊôÇÈñì„ÅÆÁü≠Á∏Æ) „Å´„Å™„Çã„Ç±„Éº„Çπ„ÅåÊÑüË¶öÁöÑ„Å´„ÅØÂ§ö„ÅÑ„Åß„Åô„ÄÇ

## „Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢„Å∏„ÅÆÂøúÁî®

Ê§úÁ¥¢„ÅåË§áÊï∞Âàó„Å´„Çè„Åü„ÇãÂ†¥Âêà„ÄÅË§áÊï∞„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Çí‰ΩúÊàê„Åó„Åå„Å°„Åß„Åô„ÄÇ „Åó„Åã„Åó pg_bigm „Åß„ÅØË§áÊï∞Âàó„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÊ§úÁ¥¢„Åô„Çã„Å®„ÄÅ„Åã„Å™„Çä„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Åå‰Ωé‰∏ã„Åô„ÇãÂÇæÂêë„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ

„ÅÇ„Çã„ÅÑ„ÅØ„ÄÅÊñáÂ≠óÂàó„Çí‰∏ÄÂÆö„ÅÆ„É´„Éº„É´„ÅßÊ≠£Ë¶èÂåñ („Å≤„Çâ„Åå„Å™„ÄÅÂçäËßíËã±Êï∞Â≠ó„Å´Â§âÊèõ) „Åó„Åü„ÅÑ„Å®„ÅÑ„ÅÜ„Éã„Éº„Ç∫„ÇÇ„Çà„Åè„ÅÇ„Çä„Åæ„Åô„ÄÇ‰æã: `„Éê„Ç§„Ç∞„É©„É†Ôº¢ÔΩâÔºßÔΩíÔΩÅÔΩç` ‚Üí `„Å∞„ÅÑ„Åê„Çâ„ÇÄbigram`

„Åù„Åì„Åß„ÄÅÂØæË±°Âàó„Çí 1 „Å§„Å´Âêà‰Ωì„Åô„Çã„Å®„ÅÑ„ÅÜÊñπÊ≥ï„ÅåÊúâÂäπ„Åß„Åô„ÄÇ

`col1||' '||col2` „Åß„ÅØ NULL „ÇíÂê´„ÇÄ„Ç±„Éº„Çπ„Åß„ÅØ NULL „Å´Â§âÊèõ„Åï„Çå„Å¶„Åó„Åæ„ÅÑ„Åæ„Åô„ÄÇ

`coalesce(col1, '')||' '||coalesce(col2, '')` „Å´„Åô„Çã„Åì„Å®„Åß NULL Âåñ„ÇíÂõûÈÅø„Åó„Åæ„Åô„ÄÇ

Ê≠£Ë¶èÂåñ„ÅÆ‰æã„Å®„Åó„Å¶„ÄÅÂÖ®‰Ωì„Å´ `lower()` „ÇíÈÅ©Áî®„Åó„Åæ„Åô: `lower(coalesce(col1, '')||' '||coalesce(col2, ''))`

[CREATE INDEX](https://www.postgresql.jp/document/17/html/sql-createindex.html) „ÅßË™¨Êòé„Åï„Çå„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å´„ÄÅÂºè„Å´Èñ¢Êï∞„Çí‰ΩøÁî®„Åô„ÇãÂ†¥Âêà„Å´„ÅØÂà∂Á¥Ñ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ

> „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅÆÂÆöÁæ©„Åß‰ΩøÁî®„Åï„Çå„ÇãÂÖ®„Å¶„ÅÆÈñ¢Êï∞„Å®ÊºîÁÆóÂ≠ê„ÅØ„ÄÅ„Äå‰∏çÂ§â„ÄçÔºàimmutableÔºâ„Åß„Å™„Åë„Çå„Å∞„Å™„Çä„Åæ„Åõ„Çì„ÄÇ „Å§„Åæ„Çä„ÄÅÁµêÊûú„ÅØÂÖ•ÂäõÂºïÊï∞„Å´„ÅÆ„Åø„Å´‰æùÂ≠ò„Åó„ÄÅÔºà‰ªñ„ÅÆ„ÉÜ„Éº„Éñ„É´„ÅÆÂÜÖÂÆπ„ÇÑÁèæÊôÇÂàª„Å™„Å©„ÅÆÔºâÂ§ñÈÉ®„Åã„Çâ„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Å¶„ÅØ„Å™„Çä„Åæ„Åõ„Çì„ÄÇ „Åì„ÅÆÂà∂Èôê„Å´„Çà„Å£„Å¶„ÄÅ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅÆÂãï‰Ωú„ÅåÂçÅÂàÜÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Çã„Åì„Å®„Åå‰øùË®º„Åï„Çå„Åæ„Åô„ÄÇ „Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂºè„ÇÑWHEREÂè•„Å´„É¶„Éº„Ç∂ÂÆöÁæ©„ÅÆÈñ¢Êï∞„Çí‰ΩøÁî®„Åô„ÇãÂ†¥Âêà„ÄÅÈñ¢Êï∞„Çí‰ΩúÊàê„Åô„ÇãÈöõ„ÄÅIMMUTABLEÔºà‰∏çÂ§âÔºâ„Ç™„Éó„Ç∑„Éß„É≥„Çí‰ªò„Åë„Çã„Åì„Å®„ÇíÂøò„Çå„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ

`lower()` „Å™„Å© `IMMUTABLE` Â±ûÊÄß„ÅÆÈñ¢Êï∞„Çí‰ΩøÁî®„Åô„ÇãÂàÜ„Å´„ÅØÂïèÈ°å„ÅÇ„Çä„Åæ„Åõ„Çì„Åå„ÄÅ Ëá™‰Ωú„ÅÆÈñ¢Êï∞„Çí‰ΩøÁî®„Åô„ÇãÂ†¥Âêà„Å´„ÅØÊ≥®ÊÑè„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ

„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅÆÁîüÂ≠òÊúüÈñì‰∏≠„Å´„ÄÅÂ§âÊèõ„É´„Éº„É´„ÅåÂ§âÂåñ„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´Ê≥®ÊÑè„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ

„ÇÇ„ÅóÂ§âÂåñ„Åó„Å¶„Åó„Åæ„Å£„ÅüÂ†¥Âêà„ÅØ„ÄÅ [REINDEX](https://www.postgresql.jp/document/17/html/sql-reindex.html) „ÇíÊâãÂãï„ÅßÂëº„Å≥Âá∫„Åô„Å™„Å©„Åó„Å¶„ÄÅ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅÆÂÜçÊßãÁØâ„Çí„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ

Âà©Áî®‰æã„Åß„Åô„ÄÇ

„ÉÜ„Éº„Éñ„É´„Å®„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Çí‰ΩúÊàê:

```sql
-- tests for creation of full-text search index
CREATE TABLE test_bigm (col1 text, col2 text);
CREATE INDEX test_bigm_idx ON test_bigm USING gin (lower(coalesce(col1, '')||' '||coalesce(col2, '')) gin_bigm_ops);
```

ÈÉ®ÂàÜ‰∏ÄËá¥„ÅßÊ§úÁ¥¢„ÄÇ `CREATE INDEX` „ÅßÊåáÂÆö„Åó„ÅüÂºè„Å®„ÄÅÂêå„ÅòÂºè„Çí `WHERE` Âè•„Å∏Ë®òËø∞„Åó„Åæ„Åô:

```sql
EXPLAIN SELECT col1 FROM test_bigm WHERE lower(coalesce(col1, '')||' '||coalesce(col2, '')) LIKE likequery(lower('Êù±‰∫¨ÈÉΩ'));
```

EXPLAIN „Çí‰ΩøÁî®„ÄÇ „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅåÊ§úÁ¥¢ÊôÇ„Å´ÈÅ©Áî®„Åï„Çå„Å¶„ÅÑ„Çã‰∫ã (`Bitmap Heap Scan` „ÅÆ‰ΩøÁî®) „ÅåÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô:

```
QUERY PLAN
Bitmap Heap Scan on test_bigm  (cost=12.00..16.02 rows=1 width=32)
  Recheck Cond: (lower(((COALESCE(col1, ''::text) || ' '::text) || COALESCE(col2, ''::text))) ~~ '%Êù±‰∫¨ÈÉΩ%'::text)
  ->  Bitmap Index Scan on test_bigm_idx  (cost=0.00..12.00 rows=1 width=0)
        Index Cond: (lower(((COALESCE(col1, ''::text) || ' '::text) || COALESCE(col2, ''::text))) ~~ '%Êù±‰∫¨ÈÉΩ%'::text)
```
